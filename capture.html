<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>capture</title>

  <script src="libs/opencv.js"></script>
  <script src="functions.js"></script>
  <script src="feed.js"></script>
  <script src="matcher.js"></script>
  <script src="slicer.js"></script>

<link rel="stylesheet" href="foundation.min.css">

  <style>
      video {
          display: none;
      }

    #cutSets canvas {
        padding: 10px;
        background: pink;
        margin: 5px;
    }

    #cutSets > div {
        display: inline-block;
        margin 0 5px;
    }

    #cutSets > div span {
        display: block;
        background: pink;
        text-align: center;
    }

    #cutSets > div canvas {
        margin: 0;
    }

    #cutSets canvas.bestMatch {
      display: block;
      background: green;
    }

    #videoPreview {
        display: inline-block;
    }

      #videoPreview canvas {
          display: inline-block;
      }

  </style>
</head>
<body>

  <div class="demo-frame">
    <div class="demo-container">
      <!--<img id="image" src="./tile1.png">-->
      <!--<img id="input" src="./tile9.png">-->
      <!--<img id="image2" src="./tile1.png">-->
      <div id="videoPreview" style="position: relative">
      <canvas id="canvasOutput0" width="600" height="300" style="opacity: 1"></canvas>
      <canvas id="canvasOutputOverlay" width="600" height="300" style="position: absolute; top: 0; left:0; opacity: 0.6"></canvas>
      </div>
      <div id="cutSets"></div>
      <canvas id="canvasOutput" width="600" height="300" style="display: none"></canvas>
    </div>
  </div>

    <button class="button primary large" id="captureStop">SHOT !</button> <span id="resolutionContainer">RESOLUTION</span> <span id="fpsCounter">FPS</span>

    <div id="samples" style="position: absolute; top: -1000px; left: -1000px"></div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log('READY', window.location.hash);
            let matcher = new TileMatcher(document.getElementById('samples'), 200);

            let done = matcher.loadSamples([
                {type: 'bamboo1', src: 'sample/bamboo-1.png'},
                {type: 'bamboo2', src: 'sample/bamboo-2.png'},
                {type: 'bamboo3', src: 'sample/bamboo-3.png'},
                {type: 'bamboo4', src: 'sample/bamboo-4.png'},
                {type: 'bamboo5', src: 'sample/bamboo-5.png'},
                {type: 'bamboo6', src: 'sample/bamboo-6.png'},
                {type: 'bamboo7', src: 'sample/bamboo-7.png'},
                {type: 'bamboo8', src: 'sample/bamboo-8.png'},
                {type: 'bamboo9', src: 'sample/bamboo-9.png'},
                {type: 'bonus-autumn', src: 'sample/bonus-autumn.png'},
                {type: 'bonus-spring', src: 'sample/bonus-sprint.png'},
                {type: 'bonus-summer', src: 'sample/bonus-summer.png'},
                {type: 'bonus-winter', src: 'sample/bonus-winter.png'},
                {type: 'bonus-flower1', src: 'sample/bonus-flower1.png'},
                {type: 'bonus-flower2', src: 'sample/bonus-flower2.png'},
                {type: 'bonus-flower3', src: 'sample/bonus-flower3.png'},
                {type: 'bonus-flower4', src: 'sample/bonus-flower4.png'},
                {type: 'dragon-green', src: 'sample/dragon-green.png'},
                {type: 'dragon-white', src: 'sample/dragon-white.png'},
                {type: 'dragon-red', src: 'sample/dragon-red.png'},
                {type: 'circle1', src: 'sample/circle-1.png'},
                {type: 'circle2', src: 'sample/circle-2.png'},
                {type: 'circle3', src: 'sample/circle-3.png'},
                {type: 'circle4', src: 'sample/circle-4.png'},
                {type: 'circle5', src: 'sample/circle-5.png'},
                {type: 'circle6', src: 'sample/circle-6.png'},
                {type: 'circle7', src: 'sample/circle-7.png'},
                {type: 'circle8', src: 'sample/circle-8.png'},
                {type: 'circle9', src: 'sample/circle-9.png'},
                {type: 'number1', src: 'sample/number-1.png'},
                {type: 'number2', src: 'sample/number-2.png'},
                {type: 'number3', src: 'sample/number-3.png'},
                {type: 'number4', src: 'sample/number-4.png'},
                {type: 'number5', src: 'sample/number-5.png'},
                {type: 'number6', src: 'sample/number-6.png'},
                {type: 'number7', src: 'sample/number-7.png'},
                {type: 'number8', src: 'sample/number-8.png'},
                {type: 'number9', src: 'sample/number-9.png'},
                {type: 'wind-east', src: 'sample/wind-east.png'},
                {type: 'wind-north', src: 'sample/wind-north.png'},
                {type: 'wind-south', src: 'sample/wind-south.png'},
                {type: 'wind-west', src: 'sample/wind-west.png'},
            ]);

            done.then(() => {
                run(matcher);
            });

    });

    function randColor() {
        return new cv.Scalar(Math.round(Math.random() * 255), Math.round(Math.random() * 255),
                                      Math.round(Math.random() * 255));
    }

    const SET_TYPE_PUNG = 'Pung';
    const SET_TYPE_KONG = 'Kong';

    function getSetTypeFromRatio(ratio) {
        if(ratio < 2.5) {
            return SET_TYPE_PUNG;
        }

        return SET_TYPE_KONG;
    }

    /**
     * @param {TileMatcher} matcher
     */
    function run(matcher) {

        let MIN_AREA = 5000;
        let THRESHOLD = 120;

        document.getElementById('captureStop').addEventListener('click', () => {
            // let d1 = new Date();
            feed.stop();

            // processVideoFull(feed.getLastFrame());
            //
            // let d2 = new Date();
            //
            // document.getElementById('fpsCounter').innerText = 'Full process time: ' + (d2-d1) + ' ms';
        });

        // let feed = new ConstantVideoFeed('photos/IMG_20180811_111345.jpg');
        // let feed = new ConstantVideoFeed('photos/IMG_20180811_111404.jpg');
        // let feed = new ConstantVideoFeed('photos/IMG_20180811_111439.jpg');
        // let feed = new ConstantVideoFeed('photos/IMG_20180811_111458.jpg');

        // let feed = new ConstantVideoFeed('photos/IMG_20180811_175030.jpg');
        // let feed = new ConstantVideoFeed('photos/IMG_20180811_1750302.jpg');
        // let feed = new ConstantVideoFeed('photos/IMG_20180811_175149.jpg');
        // let feed = new ConstantVideoFeed('photos/IMG_20180811_1751492.jpg');
        let feed = new ConstantVideoFeed('photos/IMG_20180811_164020.jpg');
        // let feed = new ConstantVideoFeed('photos/IMG_20180811_190844.jpg');
        // let feed = new ConstantVideoFeed('photos/IMG_20180811_192116.jpg');
        // let feed = new ConstantVideoFeed('images/source.jpg');
        // let feed = new VideoStreamFeed(navigator.mediaDevices, 30);

        feed.onFrame.addListener(canvas => {
            let d1 = new Date();
            processVideoFast(canvas);
            let d2 = new Date();

            document.getElementById('fpsCounter').innerText = (d2-d1) + ' ms';

            // processVideoFull(canvas);
            // feed.stop();
        });

        feed.start();

        let captureRectPosition = null;

        let canva = document.getElementById('canvasOutputOverlay');
        canva.addEventListener('click', e => {

            captureRectPosition = {
                x: e.pageX - canva.offsetLeft,
                y: e.pageY - canva.offsetTop
            };

            console.log('CLICK', captureRectPosition);
        });

        function positionInBbox(pos, bbox) {
            return pos.x >= bbox.x && pos.x <= bbox.x + bbox.width && pos.y >= bbox.y && pos.y <= bbox.y + bbox.height;
        }

        function processVideoFast(canvas) {

            let orig = cv.imread(canvas);
            let src = new cv.Mat();

            document.getElementById('resolutionContainer').innerHTML = `${orig.size().width} x ${orig.size().height}`;

            cv.cvtColor(orig, src, cv.COLOR_RGBA2GRAY, 0);
            cv.threshold(src, src, THRESHOLD, 255, cv.THRESH_BINARY);

            let overlay = cv.Mat.ones(src.rows, src.cols, cv.CV_8UC3);

            let contours = getImportantContours(src, MIN_AREA);

            contours.forEach(cnt => {
                let col = randColor();

                let bbRatio = cnt.bbox.width / cnt.bbox.height;
                let setType = getSetTypeFromRatio(bbRatio);

                if(captureRectPosition && positionInBbox(captureRectPosition, cnt.bbox)) {
                    processContour(src, cnt, setType, matcher);
                    captureRectPosition = null;
                }

                drawCnt(overlay, cnt, col);
                drawBBRect(overlay, cnt.bbox, col);



                let text = setType + ' ' + (Math.round(bbRatio * 1000) / 1000);
                let pt = new cv.Point(cnt.bbox.x + 20, cnt.bbox.y + cnt.bbox.height/2);
                cv.putText(overlay, text, pt, cv.FONT_ITALIC, 0.5, col, 2, 4);

                cnt.mat.delete();
            });

             cv.imshow('canvasOutput0', orig);
             cv.imshow('canvasOutputOverlay', overlay);

             [orig, src, overlay].forEach(obj => obj.delete())
        }

        function processContour(src, contour, setType, matcher) {
            let item = cutContour(src, contour, 1);

            let target = findContourAndFixPerspective2(item.mat);

            if(!target) {
                let cutCanvas = document.getElementById('cutSets').appendChild(document.createElement('canvas'));
                cv.imshow(cutCanvas, item.mat);
                console.warn('NO TARGET FOR', item);
                return;
            }

            // let targetContours = getImportantContours(target.mat, 10, true);
            // let clusters = simpleClusterize(targetContours, 40);

            // let edgeContours = getImportantContours(target.mat, 10, false, true);

            // cv.cvtColor(target.mat, target.mat, cv.COLOR_GRAY2RGB, 0);

            // clusters.forEach(cluster => {
            //     let col = randColor();
            //     cluster.forEach(cnt => {
            //         drawCnt(target.mat, cnt, col);
            //     });
            // });

            // edgeContours.forEach(cnt => {
            //     drawCnt(target.mat, cnt, randColor());
            // });
            //
            //
            // console.log('EDGE CNTS', edgeContours);

            let cutCanvas = document.getElementById('cutSets').appendChild(document.createElement('canvas'));
            cutCanvas.classList.add('bestMatch');
            cv.imshow(cutCanvas, target.mat);

            let slicer = new SetSlicer();

            slicer.sliceSet(target.mat, setType).forEach(img => {
                let row = document.getElementById('cutSets').appendChild(document.createElement('div'))

                // cv.imshow(cutCanvas, img);

                let tileContours = getImportantContours(img, 10, true);

                let tile = cutTileFromContours(img, tileContours);

                // cv.imshow(cutCanvas, tile.mat);

                let matchResult = matcher.matchTile(tile.mat);

                row.appendChild(document.createElement('span')).innerText =
                    matchResult.bestMatch.type + ' (' + (100-Math.round(matchResult.bestMatch.score*100)) + '%)';

                let cutCanvas = row.appendChild(document.createElement('canvas'));
                cv.imshow(cutCanvas, matchResult.bestMatch.diffImg);

                matchResult.dispose();
            })
        }

        function processVideoFull(canvas) {
            let orig = cv.imread(canvas);
            let src = new cv.Mat();

            document.getElementById('resolutionContainer').innerHTML = `${orig.size().width} x ${orig.size().height}`;

            let SCALE = 1.0;

            cv.cvtColor(orig, src, cv.COLOR_RGBA2GRAY, 0);
            cv.threshold(src, src, THRESHOLD, 255, cv.THRESH_BINARY);

            let overlay = cv.Mat.ones(src.rows, src.cols, cv.CV_8UC3);

            let contours = getImportantContours(src, MIN_AREA);

            contours.forEach(cnt => {
                drawCnt(overlay, cnt);
            });

            console.info('ALL CONTOURS', contours);

            cv.imshow('canvasOutput0', src);
            cv.imshow('canvasOutputOverlay', overlay);

            cutContours(src, contours, SCALE).slice(0).forEach(item => { // .slice(22)

                let target;

                try {

                    // try {
                        target = findContourAndFixPerspective2(item.mat);

                        if(!target) {
                            let cutCanvas = document.getElementById('cutSets').appendChild(document.createElement('canvas'));
                            cv.imshow(cutCanvas, item.mat);
                            console.warn('NO TARGET FOR', item);
                            return;
                        }
                    // }
                    // catch (e) {
                    //     console.error("FAILED TO FIND PERSPECTIVE");
                    //     return;
                    // }

                    let targetContours = getImportantContours(target.mat, 10, true);
                    let clusters = simpleClusterize(targetContours, 40);
                    // console.log('AAAA', targetContours);
                    // console.log('CLU', clusters);

                    cv.cvtColor(target.mat, target.mat, cv.COLOR_GRAY2RGB, 0);

                    clusters.forEach(cluster => {
                        let col = randColor();
                        cluster.forEach(cnt => {
                            drawCnt(target.mat, cnt, col);
                        });
                    });

                    let cutCanvas = document.getElementById('cutSets').appendChild(document.createElement('canvas'));
                    cv.imshow(cutCanvas, target.mat);


                    cv.cvtColor(target.mat, target.mat, cv.COLOR_RGB2GRAY, 0);


                    let tiles = cutTilesFromClusters(target.mat, clusters, false);
                    tiles.forEach(tile => {

                        let cutCanvas = document.getElementById('cutSets').appendChild(document.createElement('canvas'));
                        cv.imshow(cutCanvas, tile.mat);

                        let matchResult = matcher.matchTile(tile.mat);

                        let cutCanvas2 = document.getElementById('cutSets').appendChild(document.createElement('canvas'));
                        cutCanvas2.classList.add('bestMatch');
                        cv.imshow(cutCanvas2, matchResult.bestMatch.diffImg);

                        // matchResult.allMatches.forEach(match => {
                        //     let div = document.getElementById('cutSets').appendChild(document.createElement('div'));
                        //     let tmpCanvas = div.appendChild(document.createElement('canvas'));
                        //     div.appendChild(document.createTextNode(match.score));
                        // // cutCanvas2.classList.add('bestMatch');
                        //     cv.imshow(tmpCanvas, match.diffImg);
                        // })

                        console.log(matchResult);

                        matchResult.dispose();
                    })
                }
                finally {
                    if(target){
                        // let cutCanvas = document.getElementById('cutSets').appendChild(document.createElement('canvas'));
                        // cv.imshow(cutCanvas, target.mat);
                    }
                    // cv.imshow(cutCanvas, item.mat);
                    // throw e;
                }


            });



        }
        

    }


  </script>


</body></html>